# CueSports Africa - Docker Compose Configuration
# Complete development and production setup

services:
    # ============================================
    # Laravel API with Octane (FrankenPHP)
    # ============================================
    api:
        build:
            context: .
            dockerfile: docker/Dockerfile
            target: development
        container_name: cuesports-api
        restart: unless-stopped
        ports:
            - "${APP_PORT:-8000}:8000"
        environment:
            - APP_ENV=${APP_ENV:-local}
            - APP_DEBUG=${APP_DEBUG:-true}
            - APP_KEY=${APP_KEY}
            - APP_URL=${APP_URL:-http://localhost:8000}
            - DB_CONNECTION=pgsql
            - DB_HOST=postgres
            - DB_PORT=5432
            - DB_DATABASE=${DB_DATABASE:-cuesports}
            - DB_USERNAME=${DB_USERNAME:-cuesports}
            - DB_PASSWORD=${DB_PASSWORD:-secret}
            - REDIS_HOST=redis
            - REDIS_PORT=6379
            - REDIS_PASSWORD=${REDIS_PASSWORD:-null}
            - CACHE_DRIVER=redis
            - SESSION_DRIVER=redis
            - SESSION_LIFETIME=525600
            - SESSION_EXPIRE_ON_CLOSE=false
            - QUEUE_CONNECTION=redis
            - BROADCAST_DRIVER=pusher
            - OCTANE_SERVER=frankenphp
        volumes:
            - .:/app
            - ./docker/php/php-development.ini:/usr/local/etc/php/conf.d/99-development.ini
            - /app/vendor
            - /app/node_modules
        networks:
            - cuesports
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s

    # ============================================
    # Laravel Horizon (Queue Worker)
    # ============================================
    horizon:
        build:
            context: .
            dockerfile: docker/Dockerfile
            target: development
        container_name: cuesports-horizon
        restart: unless-stopped
        command: php artisan horizon
        environment:
            - APP_ENV=${APP_ENV:-local}
            - APP_DEBUG=${APP_DEBUG:-true}
            - APP_KEY=${APP_KEY}
            - DB_CONNECTION=pgsql
            - DB_HOST=postgres
            - DB_PORT=5432
            - DB_DATABASE=${DB_DATABASE:-cuesports}
            - DB_USERNAME=${DB_USERNAME:-cuesports}
            - DB_PASSWORD=${DB_PASSWORD:-secret}
            - REDIS_HOST=redis
            - REDIS_PORT=6379
            - REDIS_PASSWORD=${REDIS_PASSWORD:-null}
            - CACHE_DRIVER=redis
            - QUEUE_CONNECTION=redis
        volumes:
            - .:/app
            - /app/vendor
        networks:
            - cuesports
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy

    # ============================================
    # Laravel Scheduler (Cron)
    # ============================================
    scheduler:
        build:
            context: .
            dockerfile: docker/Dockerfile
            target: development
        container_name: cuesports-scheduler
        restart: unless-stopped
        command: /bin/sh -c "while true; do php /app/artisan schedule:run --verbose --no-interaction; sleep 60; done"
        environment:
            - APP_ENV=${APP_ENV:-local}
            - APP_DEBUG=${APP_DEBUG:-true}
            - APP_KEY=${APP_KEY}
            - DB_CONNECTION=pgsql
            - DB_HOST=postgres
            - DB_PORT=5432
            - DB_DATABASE=${DB_DATABASE:-cuesports}
            - DB_USERNAME=${DB_USERNAME:-cuesports}
            - DB_PASSWORD=${DB_PASSWORD:-secret}
            - REDIS_HOST=redis
            - REDIS_PORT=6379
            - REDIS_PASSWORD=${REDIS_PASSWORD:-null}
            - CACHE_DRIVER=redis
            - QUEUE_CONNECTION=redis
        volumes:
            - .:/app
            - /app/vendor
        networks:
            - cuesports
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy

    # ============================================
    # Next.js Frontend
    # ============================================
    frontend:
        build:
            context: ./frontend
            dockerfile: Dockerfile
            target: development
        container_name: cuesports-frontend
        restart: unless-stopped
        ports:
            - "${FRONTEND_PORT:-3000}:3000"
        environment:
            - NODE_ENV=development
            - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost:8000/api}
            - NEXT_PUBLIC_PUSHER_APP_KEY=${PUSHER_APP_KEY}
            - NEXT_PUBLIC_PUSHER_CLUSTER=${PUSHER_APP_CLUSTER:-mt1}
        volumes:
            - ./frontend:/app
            - /app/node_modules
            - /app/.next
        networks:
            - cuesports
        depends_on:
            - api

    # ============================================
    # PostgreSQL Database
    # ============================================
    postgres:
        image: postgres:16-alpine
        container_name: cuesports-postgres
        restart: unless-stopped
        ports:
            - "${FORWARD_DB_PORT:-5432}:5432"
        environment:
            - POSTGRES_DB=${DB_DATABASE:-cuesports}
            - POSTGRES_USER=${DB_USERNAME:-cuesports}
            - POSTGRES_PASSWORD=${DB_PASSWORD:-secret}
        volumes:
            - postgres_data:/var/lib/postgresql/data
            - ./docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
        networks:
            - cuesports
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-cuesports} -d ${DB_DATABASE:-cuesports}"]
            interval: 10s
            timeout: 5s
            retries: 5

    # ============================================
    # Redis Cache & Queue
    # ============================================
    redis:
        image: redis:7-alpine
        container_name: cuesports-redis
        restart: unless-stopped
        ports:
            - "${FORWARD_REDIS_PORT:-6379}:6379"
        command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
        volumes:
            - redis_data:/data
        networks:
            - cuesports
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 10s
            timeout: 5s
            retries: 5

    # ============================================
    # Nginx Reverse Proxy (Production)
    # ============================================
    nginx:
        image: nginx:alpine
        container_name: cuesports-nginx
        restart: unless-stopped
        ports:
            - "${NGINX_PORT:-80}:80"
            - "${NGINX_SSL_PORT:-443}:443"
        volumes:
            - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
            - ./docker/nginx/conf.d:/etc/nginx/conf.d:ro
            - ./docker/nginx/ssl:/etc/nginx/ssl:ro
            - ./public:/app/public:ro
        networks:
            - cuesports
        depends_on:
            - api
            - frontend
        profiles:
            - production

    # ============================================
    # Mailpit (Development Email Testing)
    # ============================================
    mailpit:
        image: axllent/mailpit
        container_name: cuesports-mailpit
        restart: unless-stopped
        ports:
            - "${MAIL_PORT:-1025}:1025"
            - "${MAILPIT_UI_PORT:-8025}:8025"
        networks:
            - cuesports
        profiles:
            - development

    # ============================================
    # MinIO (S3-Compatible Storage for Dev)
    # ============================================
    minio:
        image: minio/minio
        container_name: cuesports-minio
        restart: unless-stopped
        ports:
            - "${MINIO_PORT:-9000}:9000"
            - "${MINIO_CONSOLE_PORT:-9001}:9001"
        environment:
            - MINIO_ROOT_USER=${AWS_ACCESS_KEY_ID:-cuesports}
            - MINIO_ROOT_PASSWORD=${AWS_SECRET_ACCESS_KEY:-cuesportssecret}
        command: server /data --console-address ":9001"
        volumes:
            - minio_data:/data
        networks:
            - cuesports
        profiles:
            - development
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
            interval: 30s
            timeout: 20s
            retries: 3

    # ============================================
    # ngrok Tunnel (Remote API Access)
    # ============================================
    ngrok:
        image: ngrok/ngrok:latest
        container_name: cuesports-ngrok
        restart: unless-stopped
        command: http api:8000 --log stdout
        environment:
            - NGROK_AUTHTOKEN=${NGROK_AUTHTOKEN}
        ports:
            - "4040:4040"
        networks:
            - cuesports
        depends_on:
            api:
                condition: service_healthy

networks:
    cuesports:
        driver: bridge

volumes:
    postgres_data:
        driver: local
    redis_data:
        driver: local
    minio_data:
        driver: local
